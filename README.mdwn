
Buildbot
========

The buildbot uses docker to schedule builds. So the user you are running
with needs to have docker permissions. Most of the time this should be 
able to achieve with "adduser docker flo" for example.

For installation use this:

	apt-get install docker-ce jq 

To prepare the docker images needed to build kernels 

	buildbot/scripts/preparedocker

Then run 

	buildbot/buildbot \
		--api https://nuc.dynamic.uucico.de/bbb \
		-c docker:bbb/buster \
		-b $PWD/scripts/build

As soon as there are build jobs you should see builds beein scheduled.

BB
Api Dependencies
================

libfile-slurp-perl libmojo-server-fastcgi-perl libmojolicious-perl libjson-perl


Job status values
=================

	submitted	- Submitted by client
	waiting 	- Waiting for client to claim
	claimed 	- Claimed by client
	ok		- Returned by client ok
	failed		- Returned by client failed
	cancelled	- Canceled - Parent failed
	dependency	- Waiting for dependency

REST API 
=========

Job Status
----------

	curl -XGET https://nuc.dynamic.uucico.de/bbb/v1/job/1/status | jq

	{
	  "claimed": "p4",
	  "id": 1,
	  "processing": "2020-09-05 19:55:27.701255",
	  "queued": "2020-09-05 18:38:29.626586",
	  "requirements": [
	    "docker:bbb/buster",
	    "mips"
	  ],
	  "result": null,
	  "returned": null,
	  "type": "build",
	  "uid": "flo",
	  "variables": {
	    "commit": "HEAD",
	    "gittree": "git://git.kernel.org/pub/scm/linux/kernel/git/mips/linux.git",
	    "machine": "sb1250-bigendian"
          }	
        }

Filter jobs
-----------

To find a job matching my capabilities:

	curl -XPOST -d '{ "type": "build", "capabilities": [ "docker:bbb/buster", "mipsel" ] }' \
		https://nuc.dynamic.uucico.de/bbb/v1/job/filter

Returns a list ob jobs.

Claim a job
-----------
To claim a job for processing

	curl -XGET https://nuc.dynamic.uucico.de/bbb/v1/job/1/claim/p4

Returns a status with ok/fail and the job claimed

	{
	  "status": "fail"
	  "error": "Job already claimed",
	  "job": {
 		 ... 
	    }
	  },
	}

Submit job
==========

To submit a new job:

	curl -XPOST -d '{ "type": "build", "requirements": [ "docker:bbb/buster" ], "variables": { "foo": "bar" }}' https://nuc.dynamic.uucico.de/bbb/v1/job/submit

Returns a status ok/fail, the job id and the job json itself


Submit job
==========
	bbb-submit
		Arguments
			-j -> jobtype - string
			-r -> requirement - may be listed as often as wanted
			-v -> key/value variable setting
			-d -> depends on jobid $foo
		Returns
			jobid

	bbb-submit \
		-j build \
		-r docker:buster \
		-r arch:mips \
		-v gittree=git://git.kernel.org/pub/scm/linux/kernel/git/mips/linux.git \
		-v commit=HEAD \
		-v machine=sb1250-bigendian

	Returns the job number

	bbb-submit \
		-j boot \
		-r sb1250* \
		-d ${jobid} \
		-v kernel=${jobid}


BBB Config
==========

~/.bbb - Json content

{
	apiuser: 'flo',
	apipassword': 'verysecret',
	apiendpoint: 'https://pax.zz.de/bbb'
	s3user: 'flo',
	s3password': 'verysecret',
	s3endpoint: 'https://pax.zz.de/minio'
}





Ideas and Todos
===============

- Buildbot should autodiscover docker images
- Timeout for jobs
- If returned as failed cancel all dependencies
- Notifications?
  - How to aggregate build/boot in ONE notification?
  - How to send notification if only a parent fails?
  - Notification on success/failure
